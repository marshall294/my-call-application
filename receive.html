<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fantasy Call - Receiver</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .card {
      background: #1e1e1e;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      text-align: center;
    }

    h2 {
      font-weight: 500;
      margin-bottom: 20px;
    }

    p {
      margin: 10px 0;
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      background: #25d366;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }

    button.end {
      background: #e53935;
    }

    button:disabled {
      background: #4c9f80;
      cursor: not-allowed;
    }

    audio {
      display: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>ðŸ“ž Incoming Call</h2>
    <p id="status">Waiting for a call...</p>
    <p id="callerName"></p>
    <p id="callReason"></p>
    <button id="answerBtn" disabled>âœ… Answer</button>
    <button id="endBtn" class="end" disabled>ðŸ”´ End</button>
    <audio id="ringtone" src="waka-waka.mp3" loop></audio>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDzWe0sMFecKa9sHk30pXat5qrT4yDyuJ4",
      authDomain: "soccer2-c47c2.firebaseapp.com",
      projectId: "soccer2-c47c2",
      storageBucket: "soccer2-c47c2.appspot.com",
      messagingSenderId: "942310698005",
      appId: "1:942310698005:web:2f5230da671ef0b47db21c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    const pc = new RTCPeerConnection(servers);

    const callDoc = db.collection("calls").doc("activeCall");
    const offerCandidates = callDoc.collection("offerCandidates");
    const answerCandidates = callDoc.collection("answerCandidates");

    const ringtone = document.getElementById("ringtone");
    const statusEl = document.getElementById("status");
    const answerBtn = document.getElementById("answerBtn");
    const endBtn = document.getElementById("endBtn");
    const callerNameEl = document.getElementById("callerName");
    const callReasonEl = document.getElementById("callReason");

    let localStream;
    let remoteStream = new MediaStream();

    pc.ontrack = e => {
      remoteStream.addTrack(e.track);
      const audio = new Audio();
      audio.srcObject = remoteStream;
      audio.play();
    };

    pc.onicecandidate = e => {
      if (e.candidate) {
        answerCandidates.add(e.candidate.toJSON());
      }
    };

    // Listen for offer
    callDoc.onSnapshot(async snapshot => {
      const data = snapshot.data();
      if (data?.offer && data.ringing) {
        statusEl.innerText = "ðŸ“² Incoming call...";
        callerNameEl.innerText = "From: " + (data.offer.callerName || "Unknown");
        callReasonEl.innerText = data.offer.callReason ? "Reason: " + data.offer.callReason : "";
        answerBtn.disabled = false;

        // Play ringtone
        try { ringtone.play(); } catch (e) { console.log("Ringtone autoplay blocked"); }
      }
    });

    // Answer call
    answerBtn.onclick = async () => {
      ringtone.pause();        // âœ… Stop ringtone
      ringtone.currentTime = 0;

      answerBtn.disabled = true;
      endBtn.disabled = false;

      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      const callData = (await callDoc.get()).data();
      await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));

      const answerDescription = await pc.createAnswer();
      await pc.setLocalDescription(answerDescription);

      await callDoc.update({
        answer: {
          type: answerDescription.type,
          sdp: answerDescription.sdp
        },
        ringing: false
      });

      offerCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          }
        });
      });

      statusEl.innerText = "âœ… Call connected!";
    };

    // End call
    endBtn.onclick = async () => {
      pc.close();
      if (localStream) localStream.getTracks().forEach(track => track.stop());

      const clean = async (col) => {
        const snap = await col.get();
        return Promise.all(snap.docs.map(doc => doc.ref.delete()));
      };

      await Promise.all([
        clean(offerCandidates),
        clean(answerCandidates),
        callDoc.delete()
      ]);

      location.reload();
    };
  </script>
</body>
</html>
